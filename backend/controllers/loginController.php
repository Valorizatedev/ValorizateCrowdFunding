<?phpclass loginController extends Controller {    private $_acceso;	private $_login;	private $_config;	private $_producto;	    public function __construct() {        parent::__construct();		$this->_producto = $this->loadModel('producto', 'inventario');        $this->_acceso = $this->loadModel('usuario', 'admin');        $this->_config = $this->loadModel('config','admin');		$this->_login = $this->loadModel('login');    }    public function index() {        if (Session::get('autenticado')) {            $this->redireccionar("login/panel");        }        $this->_view->assign('titulo', 'Iniciar Sesion');        		        if ($this->getInt('enviar') == 1) {            $condicion = "usu.usu_login='{$this->getTexto('usuario')}'";             $row = $this->_acceso->consultar($condicion);            $comprobar = 0;            foreach ($row as $nombre) {                if ($nombre['usu_password'] == Hash::getHash('sha1', $this->getTexto('pass'), $nombre['usu_key'])) {                    $comprobar = 1;                    break;                }            }            if ($comprobar != 1) {                $this->_view->assign('_error', 'Usuario y/o password incorrectos');				$this->_view->assign('_tipo_error', 1);				$this->_view->renderizar('index2',false,'blank');				                exit;            }            if ($nombre['usu_estado'] != 1) {                $this->_view->assign('_error', 'Este usuario no esta habilitado');				$this->_view->assign('_tipo_error', 1);                $this->_view->renderizar('index2',false,'blank');                exit;            }            Session::set('autenticado', true);            Session::set('level', $nombre['rol_key']);            Session::set('login', $nombre['usu_login']);            Session::set('usuario', $nombre['usu_nombre'] . " " . $nombre['usu_apellidos']);            Session::set('foto', $nombre['usu_foto']);            Session::set('id_usuario', $nombre['usu_key']);            Session::set('tiempo', time());			            $this->redireccionar('login/panel');        }        $this->_view->renderizar('index','inicio','blank');    }    public function panel() {						if (session::get('autenticado')) {                        $this->_view->assign('titulo', 'Panel de Sesi&oacute;n');						$condicion = 'pro.pro_estado=1';			$productos = $this->_producto->consultar($condicion);			            //[ que productos estan menos que la configuracion del inventario            $condicion = 'config_key=1';            $valorminimo = $this->_config->consultar($condicion);                        $valorminimo=$valorminimo[0]['config_cantiad_articulos'];            $valor=0;                for ($i=0; $i <count($productos) ; $i++) {                     if ($valorminimo>$productos[$i]['pro_cantidad']) {                     $valor=1;                                           }                        }                            $this->_view->assign('alertinventario', $valor);            //]            $this->_view->assign('productos', count($productos));						$this->_view->renderizar('panel','inicio');        } else {            $this->redireccionar('index');        }    }		public function cerrar() {        Session::destroy();        $this->redireccionar();    }	 public function restablecer() {                $this->_view->assign('titulo', 'Genera una nueva clave de acceso');        $condicion = " usu.usu_email = '{$_POST['correor']}'";        $row = $this->_acceso->consultar($condicion);        $pass = Hash::generarPass();        $this->_acceso->actualizarPassword(Hash::getHash('sha1', $pass, $row[0]['usu_key']), $id);        if ($row[0]['usu_email']) {            $body = "Cordial Saludo<br/>                La presente es para informar los datos de conexion al aplicativo " . APP_NAME . ". A continuacion se informan los datos.<br/><br/>                Usuario: " . $row[0]['usu_login'] . "<br/>" . "Password: " . $pass . "<br/><br/>                Podra acceder por medio de la pagina <a href='" . BASE_URL . "'>" . BASE_URL . "</a>";            $this->getLibrary("xpm" . DS . "MAIL");            //require_once 'libs/xpm/MAIL.php';            $m = new MAIL;            $m->From(EMAIL_REMITENTE, EMAIL_NOMBRE_REMITENTE); // set from address            $m->AddTo($row[0]['usu_email']); // add to address            $m->Subject('Reset Contrase&ntilde;a'); // set subject            $m->html($body);            $c = $m->Connect(EMAIL_HOST, (int) EMAIL_SALIDA, EMAIL_USER, EMAIL_PASS) or die(print_r($m->Result));            $m->Send($c);            $m->Disconnect();        }        $this->redireccionar('index', 'login');    }	public function historial()	{			$datos = $this->_login->dona();			echo json_encode($datos);	}		}?>